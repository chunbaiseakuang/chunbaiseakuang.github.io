<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>npm install 原理 | kkkuang的知识库</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/jennie1.ico">
    <meta name="description" content="呜哇">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/assets/css/0.styles.495d9abf.css" as="style"><link rel="preload" href="/assets/js/app.a82c88d2.js" as="script"><link rel="preload" href="/assets/js/2.d1d3a4ee.js" as="script"><link rel="preload" href="/assets/js/75.7e064011.js" as="script"><link rel="prefetch" href="/assets/js/10.d91cf0d3.js"><link rel="prefetch" href="/assets/js/11.084f1158.js"><link rel="prefetch" href="/assets/js/12.2513d22b.js"><link rel="prefetch" href="/assets/js/13.6a6747a1.js"><link rel="prefetch" href="/assets/js/14.dc7a59c4.js"><link rel="prefetch" href="/assets/js/15.a9e642ce.js"><link rel="prefetch" href="/assets/js/16.5a8a2e50.js"><link rel="prefetch" href="/assets/js/17.f181867e.js"><link rel="prefetch" href="/assets/js/18.ba3c6933.js"><link rel="prefetch" href="/assets/js/19.846445bc.js"><link rel="prefetch" href="/assets/js/20.b2303ea0.js"><link rel="prefetch" href="/assets/js/21.1122dad1.js"><link rel="prefetch" href="/assets/js/22.9d3b0f46.js"><link rel="prefetch" href="/assets/js/23.5a131b68.js"><link rel="prefetch" href="/assets/js/24.05feb3f1.js"><link rel="prefetch" href="/assets/js/25.b0a3fe74.js"><link rel="prefetch" href="/assets/js/26.486fc8ac.js"><link rel="prefetch" href="/assets/js/27.3527395d.js"><link rel="prefetch" href="/assets/js/28.1d4484ad.js"><link rel="prefetch" href="/assets/js/29.d9188d03.js"><link rel="prefetch" href="/assets/js/3.c52576f6.js"><link rel="prefetch" href="/assets/js/30.e1a69a19.js"><link rel="prefetch" href="/assets/js/31.0d112323.js"><link rel="prefetch" href="/assets/js/32.1ffadf78.js"><link rel="prefetch" href="/assets/js/33.661deaab.js"><link rel="prefetch" href="/assets/js/34.d4821f1a.js"><link rel="prefetch" href="/assets/js/35.cb3269b8.js"><link rel="prefetch" href="/assets/js/36.5d3a7f3f.js"><link rel="prefetch" href="/assets/js/37.210b72b9.js"><link rel="prefetch" href="/assets/js/38.77b44fd6.js"><link rel="prefetch" href="/assets/js/39.a3c9e1c4.js"><link rel="prefetch" href="/assets/js/4.7fea489f.js"><link rel="prefetch" href="/assets/js/40.5ae8dc67.js"><link rel="prefetch" href="/assets/js/41.ab3afa52.js"><link rel="prefetch" href="/assets/js/42.0bc710d3.js"><link rel="prefetch" href="/assets/js/43.3eca11e2.js"><link rel="prefetch" href="/assets/js/44.a6af4583.js"><link rel="prefetch" href="/assets/js/45.08c4b6f3.js"><link rel="prefetch" href="/assets/js/46.07556dbd.js"><link rel="prefetch" href="/assets/js/47.e60136de.js"><link rel="prefetch" href="/assets/js/48.60c78b7b.js"><link rel="prefetch" href="/assets/js/49.ef8c0a77.js"><link rel="prefetch" href="/assets/js/5.4f56dc33.js"><link rel="prefetch" href="/assets/js/50.f8f8a4fe.js"><link rel="prefetch" href="/assets/js/51.f5c18bd6.js"><link rel="prefetch" href="/assets/js/52.02290001.js"><link rel="prefetch" href="/assets/js/53.0f3b07da.js"><link rel="prefetch" href="/assets/js/54.ce02cd26.js"><link rel="prefetch" href="/assets/js/55.81b3d7a8.js"><link rel="prefetch" href="/assets/js/56.18dec65b.js"><link rel="prefetch" href="/assets/js/57.58218246.js"><link rel="prefetch" href="/assets/js/58.6a34fc8a.js"><link rel="prefetch" href="/assets/js/59.1dd8884b.js"><link rel="prefetch" href="/assets/js/6.72ad7c85.js"><link rel="prefetch" href="/assets/js/60.36c9403e.js"><link rel="prefetch" href="/assets/js/61.0942e460.js"><link rel="prefetch" href="/assets/js/62.88a0b2e9.js"><link rel="prefetch" href="/assets/js/63.b34449f2.js"><link rel="prefetch" href="/assets/js/64.9626b5fa.js"><link rel="prefetch" href="/assets/js/65.ed86fc46.js"><link rel="prefetch" href="/assets/js/66.0e294e88.js"><link rel="prefetch" href="/assets/js/67.a5ac12d5.js"><link rel="prefetch" href="/assets/js/68.d6a0c7bc.js"><link rel="prefetch" href="/assets/js/69.ebd0f8bd.js"><link rel="prefetch" href="/assets/js/7.2e1847d4.js"><link rel="prefetch" href="/assets/js/70.6cdc7ac1.js"><link rel="prefetch" href="/assets/js/71.30cb7989.js"><link rel="prefetch" href="/assets/js/72.454d9d76.js"><link rel="prefetch" href="/assets/js/73.d043f2f3.js"><link rel="prefetch" href="/assets/js/74.f88352ce.js"><link rel="prefetch" href="/assets/js/76.81a995d4.js"><link rel="prefetch" href="/assets/js/77.899f6162.js"><link rel="prefetch" href="/assets/js/78.ac142af1.js"><link rel="prefetch" href="/assets/js/79.150c553d.js"><link rel="prefetch" href="/assets/js/8.48374f86.js"><link rel="prefetch" href="/assets/js/80.f92ea760.js"><link rel="prefetch" href="/assets/js/81.2667c791.js"><link rel="prefetch" href="/assets/js/82.dbae59c8.js"><link rel="prefetch" href="/assets/js/83.13bdf690.js"><link rel="prefetch" href="/assets/js/84.6307b62b.js"><link rel="prefetch" href="/assets/js/85.ee048a04.js"><link rel="prefetch" href="/assets/js/86.1fce373d.js"><link rel="prefetch" href="/assets/js/87.327dc572.js"><link rel="prefetch" href="/assets/js/88.7ac77895.js"><link rel="prefetch" href="/assets/js/9.9895cb7d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.495d9abf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">kkkuang的知识库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/es6/" class="nav-link">
  ES6
</a></div><div class="nav-item"><a href="/CSS/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/JavaScript/" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/work/" class="nav-link">
  工程化
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/OBKoro1" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/OBKoro1/Brush_algorithm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法仓库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/es6/" class="nav-link">
  ES6
</a></div><div class="nav-item"><a href="/CSS/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/JavaScript/" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/work/" class="nav-link">
  工程化
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/OBKoro1" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/OBKoro1/Brush_algorithm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法仓库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>工程化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/npm install 原理/" aria-current="page" class="active sidebar-link">npm install 原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/npm install 原理/#嵌套结构" class="sidebar-link">嵌套结构</a></li><li class="sidebar-sub-header"><a href="/pages/npm install 原理/#扁平结构" class="sidebar-link">扁平结构</a></li><li class="sidebar-sub-header"><a href="/pages/npm install 原理/#lock文件" class="sidebar-link">Lock文件</a></li><li class="sidebar-sub-header"><a href="/pages/npm install 原理/#缓存" class="sidebar-link">缓存</a></li><li class="sidebar-sub-header"><a href="/pages/npm install 原理/#文件完整性" class="sidebar-link">文件完整性</a></li><li class="sidebar-sub-header"><a href="/pages/npm install 原理/#整体流程" class="sidebar-link">整体流程</a></li><li class="sidebar-sub-header"><a href="/pages/npm install 原理/#注意点" class="sidebar-link">注意点</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="npm-install-原理"><a href="#npm-install-原理" class="header-anchor">#</a> npm install 原理</h1> <h2 id="嵌套结构"><a href="#嵌套结构" class="header-anchor">#</a> 嵌套结构</h2> <ul><li>我们都知道，执行 npm install 后，依赖包被安装到了 node_modules ，下面我们来具体了解下，npm 将依赖包安装到 node_modules 的具体机制是什么?</li> <li>早期版本：以递归的形式，严格按照 package.json 结构以及子依赖包的 package.json 结构将依赖安装到他们各自的 node_modules 中。直到有子依赖包不在依赖其他模块</li> <li>举个例子，我们的模块 my-app 现在依赖了两个模块：buffer、ignore</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my-app&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;buffer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.4.3&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ignore&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.1.4&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>ignore是一个纯 JS 模块，不依赖任何其他模块，而 buffer 又依赖了下面两个模块：base64-js 、 ieee754</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;buffer&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;base64-js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ieee754&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.1.4&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><p>那么，执行 npm install 后，得到的 node_modules 中模块目录结构就是下面这样的：
<img src="/img/npm1.png" alt="嵌套结构"></p></li> <li><p>如果你依赖的模块非常之多，你的 node_modules 将非常庞大，嵌套层级非常之深。在不同层级的依赖中，可能引用了同一个模块，导致大量冗余；在 Windows 系统中，文件路径最大长度为260个字符，嵌套层级过深可能导致不可预知的问题</p></li></ul> <h2 id="扁平结构"><a href="#扁平结构" class="header-anchor">#</a> 扁平结构</h2> <ul><li><p>安装模块时，不管其是直接依赖还是子依赖的依赖，优先将其安装在 node_modules 根目录
<img src="/img/npm2.png" alt="扁平结构"></p></li> <li><p>此时我们若在模块中又依赖了 base64-js@1.0.1 版本,注意这里package.json没有^，表示一定要1.0.1才符合</p></li> <li><p>当安装到相同模块时，判断已安装的模块版本是否符合新模块的版本范围，如果符合则跳过，不符合则在当前模块的 node_modules 下安装该模块（不符合，按嵌套结构排下去）。</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my-app&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;buffer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.4.3&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ignore&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.1.4&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;base64-js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.1&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><img src="/img/npm3.png" alt="不符合，按嵌套结构排下去"> <ul><li>对应的，如果我们在项目代码中引用了一个模块，模块查找流程也是先 在当前模块路径下搜索=&gt;在当前模块 node_modules 路径下搜素 =&gt;在上级模块的 node_modules 路径下搜索 =&gt; 直到搜索到全局路径中的 node_modules</li> <li>试想一下，你的APP假设没有依赖 base64-js@1.0.1 版本，而你同时依赖了依赖不同 base64-js 版本的 buffer 和 buffer2。由于在执行 npm install 的时候，按照 package.json 里依赖的顺序<strong>依次</strong>解析，则 buffer 和 buffer2 在  package.json 的放置顺序则决定了 node_modules 的依赖结构(就是说谁先放在根目录下面的node modules)</li></ul> <h2 id="lock文件"><a href="#lock文件" class="header-anchor">#</a> Lock文件</h2> <ul><li>为了解决 npm install 的不确定性问题，在 npm 5.x 版本新增了 package-lock.json 文件，而安装方式还沿用了 npm 3.x 的扁平化的方式。package-lock.json 的作用是锁定依赖结构，即只要你目录下有 package-lock.json 文件，那么你每次执行 npm install 后生成的 node_modules 目录结构一定是完全相同的。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my-app&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;buffer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.4.3&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ignore&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.1.4&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;base64-js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.1&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在执行 npm install 后生成的 package-lock.json 如下：</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my-app&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;base64-js&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.1&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;resolved&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://registry.npmjs.org/base64-js/-/base64-js-1.0.1.tgz&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha1-aSbRsZT7xze47tUTdW3i/Np+pAg=&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;buffer&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5.4.3&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;resolved&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://registry.npmjs.org/buffer/-/buffer-5.4.3.tgz&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha512-zvj65TkFeIt3i6aj5bIvJDzjjQQGs4o/sNoezg1F1kYap9Nu2jcUdpwzRSJTHMMzG0H7bZkn4rNQpImhuxWX2A==&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;requires&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;base64-js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.2&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;ieee754&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.1.4&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;base64-js&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.3.1&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;resolved&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://registry.npmjs.org/base64-js/-/base64-js-1.3.1.tgz&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha512-mLQ4i2QO1ytvGWFWmcngKO//JXAQueZvwEKtjgQFM4jIK0kU+ytMfplL8j+n5mspOfjHwoAg+9yhb7BwAHm36g==&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ieee754&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.1.13&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;resolved&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://registry.npmjs.org/ieee754/-/ieee754-1.1.13.tgz&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha512-4vf7I2LYV/HaWerSo3XmlMkp5eZ83i+/CDluXi/IGTs/O1sejBNhTtnxzmRZfvOUqj7lZjqHkeTvpgSFDlWZTg==&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ignore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5.1.4&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;resolved&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://registry.npmjs.org/ignore/-/ignore-5.1.4.tgz&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha512-MzbUSahkTW1u7JpKKjY7LCARd1fU5W2rLdxlM4kdkayuCwZImjkpluF9CM1aLewYJguPDqewLam18Y6AU69A8A==&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><ul><li><p>package-lock.json属性介绍：
<img src="/img/npm4.png" alt="lock属性介绍"></p></li> <li><p>requires：对应子依赖的依赖，与子依赖的 package.json 中 dependencies的依赖项相同。</p></li> <li><p>dependencies：结构和外层的 dependencies 结构相同，存储安装在子依赖 node_modules 中的依赖包。</p></li> <li><p>这里注意，并不是所有的子依赖都有 dependencies 属性，只有子依赖的依赖和当前已安装在根目录的  node_modules 中的依赖冲突之后，才会有这个属性</p></li> <li><p>resolved：包具体的安装来源</p></li> <li><p>integrity：包 hash 值，基于 Subresource Integrity 来验证已安装的软件包是否被改动过、是否已失效</p></li></ul> <img src="/img/npm5.png" alt="目前的依赖结构"> <ul><li>我们在 my-app 中依赖的 base64-js@1.0.1 版本与 buffer 中依赖的 base64-js@^1.0.2 发生冲突，所以  base64-js@1.0.1  需要安装在 buffer 包的 node_modules 中，对应了 package-lock.json 中 buffer 的 dependencies 属性。这也对应了 npm 对依赖的扁平化处理方式。所以，根据上面的分析， package-lock.json 文件 和 node_modules 目录结构是一一对应的，即项目目录下存在  package-lock.json 可以让每次安装生成的依赖目录结构保持相同。</li> <li>项目中使用了 package-lock.json 可以显著加速依赖安装时间，package-lock.json 中已经缓存了每个包的具体版本和下载链接，不需要再去远程仓库进行查询，然后直接进入文件完整性校验环节，减少了大量网络请求;锁定安装时的包版本号，以保证其他人在install时候，大家的依赖版本相同,一般为了稳定性考虑我们不能随意升级依赖包，因为如果换包导致兼容性bug出现很难排查，所以package-lock.json就是来解决包锁定不升级问题的</li></ul> <h2 id="缓存"><a href="#缓存" class="header-anchor">#</a> 缓存</h2> <ul><li>在执行 npm install 或 npm update命令下载依赖后，除了将依赖包安装在node_modules 目录下外，还会在本地的缓存目录缓存一份。通过 npm config get cache 命令可以查询到：在 Linux 或 Mac 默认是用户主目录下的 .npm/_cacache 目录(C:\Users\kuangchaoyu\AppData\Roaming\npm-cache_cacache)。</li> <li>在这个目录下又存在两个目录：content-v2、index-v5，content-v2 目录用于存储 tar包的缓存，而index-v5目录用于存储tar包的 hash。</li> <li>npm 在执行安装时，可以根据 <strong>package-lock.json</strong> 中存储的 integrity、version、name 生成一个唯一的 key 对应到 index-v5 目录下的缓存记录，从而找到 tar包的 hash，然后根据 hash 再去找缓存的 tar包直接使用(省去了查询远程仓库步骤)。</li></ul> <h2 id="文件完整性"><a href="#文件完整性" class="header-anchor">#</a> 文件完整性</h2> <ul><li>用户下载依赖包到本地后，需要确定在下载过程中没有出现错误，所以在下载完成之后需要在本地在计算一次文件的 hash 值，如果两个 hash 值是相同的，则确保下载的依赖是完整的，如果不同，则进行重新下载</li></ul> <h2 id="整体流程"><a href="#整体流程" class="header-anchor">#</a> 整体流程</h2> <ul><li><p>检查 .npmrc 文件：优先级为：项目级的 .npmrc 文件 &gt; 用户级的 .npmrc 文件&gt; 全局级的 .npmrc 文件 &gt; npm 内置的 .npmrc 文件 （registry=http://registry.npm.xxxx.com，在npm i 的时候，如果项目根目录下有这个文件，会自动从这个镜像地址下安装node_modules，不需要手动设置镜像地址）</p></li> <li><p>检查项目中有无 lock 文件。</p> <ul><li>无 lock 文件：
<ul><li>从 npm 远程仓库获取包信息</li> <li>根据 package.json 构建依赖树，构建过程：
构建依赖树时，不管其是直接依赖还是子依赖的依赖，优先将其放置在 node_modules 根目录。当遇到相同模块时，判断已放置在依赖树的模块版本是否符合新模块的版本范围，如果符合则跳过，不符合则在当前模块的 node_modules 下放置该模块。注意这一步只是确定逻辑上的依赖树，并非真正的安装，后面会根据这个依赖结构去下载或拿到缓存中的依赖包</li> <li>在缓存中依次查找依赖树中的每个包
<ul><li>不存在缓存：
<ul><li>从 npm 远程仓库下载包（npm 模块仓库提供了一个查询服务，叫做 registry 。以 npmjs.org 为例，它的查询服务网址是 https://registry.npmjs.org/ 。这个网址后面跟上模块名，就会得到一个 JSON 对象，里面是该模块所有版本的信息。比如，访问 https://registry.npmjs.org/react，就会看到 react 模块所有版本的信息）</li> <li>校验包的完整性</li> <li>校验不通过：重新下载</li> <li>校验通过：将下载的包复制到 npm 缓存目录；将下载的包按照依赖结构解压到 node_modules</li></ul></li> <li>存在缓存：将缓存按照依赖结构解压到 node_modules</li></ul></li> <li>将包解压到 node_modules</li> <li>生成 lock 文件</li></ul></li> <li>有 lock 文件：检查 package.json 中的依赖版本是否和 package-lock.json 中的依赖有冲突。如果没有冲突，直接跳过获取包信息、构建依赖树过程，开始在缓存中查找包信息，后续过程相同</li></ul> <img src="/img/npm6.png" alt="npm安装流程"></li></ul> <h2 id="注意点"><a href="#注意点" class="header-anchor">#</a> 注意点</h2> <ul><li>npm install 命令用来安装模块到node_modules目录。安装之前，npm install会先检查，node_modules目录之中是否已经存在指定模块。如果存在，就不再重新安装了，即使远程仓库已经有了一个新版本，也是如此。如果你希望，一个模块不管是否安装过，npm 都要强制重新安装，可以使用-f或--force参数</li> <li>如果想更新已安装模块，就要用到npm update命令。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  npm update <span class="token operator">&lt;</span>packageName<span class="token operator">&gt;</span>
  npm i packageName@next
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>在 package.json 中定义这样的依赖项的真正好处是，任何有权访问 package.json 的人都可以创建一个包含运行应用程序所需模块的依赖项文件夹，但是让我们来看看事情可能出错的具体方式。假设我们创建了一个将使用 express 的新项目。 运行npm init后，我们安装express：npm install express - save。在编写代码时，最新的版本是4.15.4，所以 “express”：“^ 4.15.4”作为我的package.json中的依赖项添加，并且我的电脑安装了确切的版本。现在也许明天，express 的维护者会发布 bug 修复，因此最新版本变为4.15.5。 然后，如果有人想要为我的项目做贡献，他们会克隆它，然后运行`npm install。'因为4.15.5是具有相同主要版本的更高版本，所以为它们安装。 我们都安装 express ，但我们却是不同的版本。从理论上讲，它们应该仍然是兼容的，但也许bugfix会影响我们正在使用的功能，而且当使用Express版本4.15.4和4.15.5运行时，我们的应用程序会产生不同的结果，package-lock.json就是解决这样的问题</li> <li>语义版本控制由三部分组成：X，Y，Z，分别是主要版本，次要版本和补丁版本。例如：1.2.3，主要版本1，次要版本2，补丁3，补丁中的更改表示不会破坏任何内容的错误修复。 次要版本的更改表示不会破坏任何内容的新功能。 主要版本的更改代表了一个破坏兼容性的大变化。 如果用户不适应主要版本更改，则内容将无法正常工作</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a82c88d2.js" defer></script><script src="/assets/js/2.d1d3a4ee.js" defer></script><script src="/assets/js/75.7e064011.js" defer></script>
  </body>
</html>
